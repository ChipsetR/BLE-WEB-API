<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Industrial BLE Monitor</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0f1e">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

<style>
:root {
  --bg: #0a0f1e;
  --card: #141b2d;
  --text: #eaeaea;
  --accent: #00c8ff;
  --danger: #ff4d4d;
}
.light {
  --bg: #f2f2f2;
  --card: #ffffff;
  --text: #111;
}
body {
  margin:0;
  font-family: Tahoma, sans-serif;
  background: var(--bg);
  color: var(--text);
}
.container {
  padding: 12px;
}
.card {
  background: var(--card);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,.4);
}
button, input {
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:10px;
  border:none;
  font-size:15px;
}
button {
  background: var(--accent);
  color:black;
  font-weight:bold;
}
.secondary {
  background:#444;
  color:white;
}
.danger {
  background: var(--danger);
}
.row {
  display:flex;
  gap:8px;
}
.row button { flex:1 }
.timer {
  font-size:26px;
  text-align:center;
  font-weight:bold;
}
canvas {
  max-height:320px;
}
.toggle {
  text-align:center;
  cursor:pointer;
}
</style>
</head>

<body>
<div class="container">

<div class="card">
  <button onclick="connectBLE()">ğŸ”µ Ø§ØªØµØ§Ù„ Ø¨Ù„ÙˆØªÙˆØ«</button>
</div>

<div class="card">
  <canvas id="chart"></canvas>
</div>

<div class="card">
  <div class="timer" id="timer">00.00</div>
  <div class="row">
    <button onclick="startTimer()">Start</button>
    <button class="secondary" onclick="stopTimer()">Stop</button>
  </div>
</div>

<div class="card">
  <input id="sens" type="number" placeholder="ØªÙ†Ø¸ÛŒÙ… Ø­Ø³Ø§Ø³ÛŒØª">
  <button onclick="sendSensitivity()">Ø§Ø±Ø³Ø§Ù„ Ø­Ø³Ø§Ø³ÛŒØª</button>
</div>

<div class="card">
  <button class="danger" onclick="resetAll()">Reset Chart & Timer</button>
</div>

<div class="card toggle" onclick="toggleTheme()">ğŸŒ™ / â˜€ï¸ ØªØºÛŒÛŒØ± ØªÙ…</div>

</div>

<script>
/* ---------- BLE ---------- */
const SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const RX = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const TX = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

let rxChar, txChar;

/* ---------- Chart ---------- */
let dataIndex = 0;
const ctx = document.getElementById('chart');

const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      data: [],
      borderWidth: 3,
      tension: 0.35,
      segment: {
        borderColor: ctx => ctx.p1.parsed.y < 2500 ? '#66ccff' : '#ff3333'
      }
    }]
  },
  options: {
    animation: { duration: 400 },
    scales: {
      y: {
        min: 0,
        max: 4000,
        ticks: { stepSize: 250 }
      }
    },
    plugins: {
      legend: { display: false },
      zoom: {
        zoom: {
          wheel: { enabled: true },
          pinch: { enabled: true },
          mode: 'x'
        },
        pan: { enabled: true, mode: 'x' }
      }
    }
  }
});

/* ---------- Timer ---------- */
let t = 0, timerInt = null;
function startTimer() {
  if(timerInt) return;
  timerInt = setInterval(() => {
    t += 0.01;
    document.getElementById('timer').innerText = t.toFixed(2);
  }, 10);
}
function stopTimer() {
  clearInterval(timerInt);
  timerInt = null;
}

/* ---------- BLE ---------- */
async function connectBLE() {
  const device = await navigator.bluetooth.requestDevice({
    filters: [{ name: 'ESP32-WebBLE' }],
    optionalServices: [SERVICE]
  });
  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(SERVICE);
  rxChar = await service.getCharacteristic(RX);
  txChar = await service.getCharacteristic(TX);

  await txChar.startNotifications();
  txChar.addEventListener('characteristicvaluechanged', e => {
    const val = parseInt(new TextDecoder().decode(e.target.value));
    addPoint(val);
  });
}

function addPoint(v) {
  chart.data.labels.push(dataIndex++);
  chart.data.datasets[0].data.push(v);
  chart.update();
}

function sendSensitivity() {
  const v = document.getElementById('sens').value;
  rxChar.writeValue(new TextEncoder().encode(v));
}

function resetAll() {
  chart.data.labels = [];
  chart.data.datasets[0].data = [];
  chart.update();
  stopTimer();
  t = 0;
  timer.innerText = "00.00";
}

function toggleTheme() {
  document.body.classList.toggle('light');
}
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
    .then(reg => console.log('SW registered:', reg))
    .catch(err => console.log('SW registration failed:', err));
  });
}
</script>

</body>
</html>
